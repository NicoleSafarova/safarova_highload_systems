# Курсовая работа  
**Автор:** Николь Сафарова

## 1. Тема  
"**Wildberries**" — крупнейший российский маркетплейс. Платформа для продажи товаров разных категорий.


### Аудитория

#### Целевая аудитория:
- Граждане Российской Федерации (преимущественно 25-34 лет) 
- Женщин 66%
- Мужчин 34%


| Страна      | % пользователей |
|-------------|-----------------|
| Россия      | 94.05  |
| Казахстан  | 1.26  |
| Беларусь      | 1.15  |
| Армения  | 0.52  |
| Другие      | 3.02  |


### Функционал MVP

 1. Создание аккаунта и каталог товаров
 2. Добавление товаров в корзину и оформление заказа
 3. Открытие каждой карточки товара
 4. Написание отзывов
 5. Система уведомлений
 6. Добавление товара на платформу со стороны продавца
 7. Поиск товара
 8. Обновление инфоормации об остатках товара на складе
 9. Оценка логистики, связь доставки товара до пункта выдачи
---

## 2. Расчет нагрузки

### Технические и продуктовые метрики
- MAU: 86,3M
- DAU: 35.5M
- Продаваемых товаров на платформе: 44M
- Количество продавцов (данные 2022): 840 000
- Среднее время сессии: 10 минут
- Количество заказов в день: 4.5M
- Среднее число запросов одного визита: 12 страниц (карточек)
- Размер файла фотографии для товара: 10 МБ максимум
- Количество фотографий на одну карточку товара: до 30 штук


#### 1. Размер хранения
Пусть на хранение текстовой информации о товаре составляет 5КБ. Возьмем примерно 5МБ = 5000КБ на хранение 1 офотографии и возьмем примерно 10 фотографий на каждую карточку.
```
44 000 000 товаров × 5000КБ * 10 фотографий = 2200000000000 КБ = 2200 ТБ

44 000 000 товаров × 5КБ = 220000000 КБ = 0.22 ТБ

0.22 ТБ + 2200ТБ = 2200.22 ТБ на хранение товаров на маркетплейсе
```

Пусть на хранение информации о пользователе, адресов пунктов выдачи о товаре составляет 5КБ. Всего 79 миллионов уникальных полтзователей.
```
86300000 пользователей * 5KБ = 395000000 КБ = 0.395 ТБ на хранение данных о пользователях
```

Пусть на хранение отзывов о товаре с картинками и видео составляет 3КБ. Возьмем в среднем по 50 отзывов на товар.
```
44000000 товаров * 50 * 3KБ = 6600000000 КБ = 6.6 ТБ на хранение данных о пользователях
```
#### 2. Сетевой трафик
```
35 500 000 активных пользователей × 12 карточек за сеанс = 426 888 000 запросов/день

```

| Тип трафика      | Среднесуточная нагрузка | Пиковая нагрузка |
|-------------|-----------------|-----------------|
| Статика (исходящий, 70%) | 150 000 000 * 0.7 * 2 МБ * 0.7 = 147000000 МБ = 147000 ГБ   | - |
| API (исходящий, 25%) | 150 000 000 * 0.25 * 50 МБ = 1875000000 КБ = 1875 ГБ  | - | 
| Заказы и действия (входящий, 5%) | 4.5M * 15 КБ + 12.5M * 50 * 2 КБ = 1 317 500 000 КБ = 1 317.5 ГБ | - |
| Сумма | 150192 ГБ/день | 70 ГБитт/с |

#### 3. RPS
```
35 500 000 активных пользователей × 12 карточек за сеанс = 426 888 000 запросов/день

```

| Функционал      | Расчеты | Средний RPS | Пиковый RPS (х5) |
|-------------|-----------------|-----------------|-----------------|
| Просмотр карточек | 426 888 000 * 0.5 / 86400   | 2470 | 12352 |
| Поиск и просмотр ленты | 426 888 000 * 0.1 / 86400  | 494 | 2470 |
| Добавление в корзину | 4 500 000 / 86400 | 52 | 260 |
| Оформление заказа | 4 500 000  / 86400 | 52 | 260 |
| Авторизация | 35 500 000 * 0.1 / 86400 | 41 | 205 |
| Регистрация | 1 300 000 / 86400  | 15 | 75 |
| Отзывы и вопросы | 4 500 000 * 0.05 / 86400  | 3 | 15 |
| Загрузка изображений | 50 * 35 500 000 * 0.01 / 86400  | 205 | 1027 |
| Изменение данных в профиле или добавление адреса пункта выдачи | 35 500 000 * 0.1 / 86400 | 41 | 205 |
| Обновление инфоормации об остатках товара на складе | 4 500 000 / 86400  | 52 | 260 |
| Логистика | 4 500 000 * 0.1 / 86400  | 92 | 458 |
| Сумма | -  | 3487 | 17587 |

## 3. Глобальная балансировка нагрузки
#### 1. Функциональное разбиение по доменам
https://www.wildberries.ru/ - основной

https://digital.wildberries.ru/ - цифровой Wildberries

https://seller.wildberries.ru/ - для продавцов 


#### 2. Обоснование расположения ДЦ (влияние на продуктовые метрики)
Дата-центры стоит располагать в России (так как большая часть аудитории - это жители России). Я решила расположить 2 ДЦ в Москве и Подмосковье. Основная база данных тоже будет в Москве.

![Загруженность ПВЗ по России](https://wiki.mpstats.io/%D0%B3%D0%B5%D0%BE%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D1%8F_%D0%B7%D0%B0%D0%BA%D0%B0%D0%B7%D0%BE%D0%B2_14.jpg)

#### 3. Схема Anycast балансировки 
По количеству заказов пользователей (на картинке видно по цвету) логично было бы расположить ДЦ в Москве и в Санкт-Петербурге. 
Но задержка трафика между Санкт-Петербуром и Москвой составляет 7,09 мс, поэтому расположим их 2 ДЦ в Москве.
Так как 2 ДЦ в одном городе, то будем использовать BGP Anycast балансировку.
Один ДЦ полностью способен выдержать всю нагрузку (вывод сделан из того, что настоящий ВБ имеет на данный момент 1 ДЦ), но сделаем 2 на случай если упадет один, то работа не прекращалась.

Схема BGP Anycast:
1) Задаем 1 IP-адресс для этих двух ДЦ;
2) С помощью протокола BGP, BGP-маршрутизаторы в сети клиента определяют лучший маршрут и направляет его в доступный узел (трафик автоматически направляется к ближайшему ДЦ);
3) Если один узел недоступный,то клиента отправляет на ближайший доступный.


## 4. Локальная балансировка нагрузки

### Схема локальной балансировки
После попадания пользователя на один из ДЦ, его запрос обрабатывается L4-балансировщиком, который использует алгоритм Least Connections (распределяет на машину с наименьшим числом подключений) для распределения трафика между L7 балансировщиками. Каждый L7-балансировщик работает на отдельной машине с установленным Nginx, где происходит терминация SSL и распределение по серверам на бэкенде.
![Схема локальной балансировки](Локальная%20балансировка.png)

| Компонент     | Формула резервирования |
|-------------|-----------------|
| L4-балансировщики | N+1 |
| L7-балансировщики | N+1 |
| Бэкенд серверы | N+1 |


## 5. Логическая БД

Пользователи (users) → Заказы (orders) → Элементы заказа (order_items)
    ↓
Корзины (carts) ← Товары (products) → Категории (categories)
    ↓              ↓
Продавцы (sellers) → Склады (sklad) → Остатки (stocks)

![Логическая схема БД](Highload%20Diagram.png)

| Таблица | Назначение |
|---------|------------|
| **users** | Основная информация о пользователях |
| **user_addresses** | Адреса доставки | 
| **user_preferences** | Адреса ПВЗ | 
| **sellers** | Информация о продавцах | 
| **categories** | Категории товаров | 
| **products** | Основная информация о товарах |  
| **product_images** | Изображения товаров | 
| **orders** | Заголовки заказов |   
| **order_items** | Состав заказов |  
| **sklad** | Склады |  
| **stocks** | Остатки товаров |  
| **carts** | Корзины покупок |   
| **cart_items** | Элементы корзины |  
| **product_search_cache** | Кэш поиска | 
| **sessions** | Сессии |  
| **replies** | Отзывы |  

#### Расчтеты

| Название таблицы | Расчеты | Результат |  Запись | Чтение |
|------------------|------|------|-------------------|-------------------|
| **users** | 86.3M × 2 КБ | 172.6 ГБ | 410 QPS | 8,200 QPS |
| **user_addresses** | 129.5M × 1 КБ | 129.5 ГБ | 245 QPS | 4100 QPS |
| **user_preferences** | 86.3M × 0.5 КБ | 43.2 ГБ | 165 QPS | 6560 QPS |
| **sellers** | 840K × 3 КБ | 2.5 ГБ | 84 QPS | 3360 QPS |
| **categories** | 7541 × 1 КБ | 7541 КБ | 1 QPS | 1,000 QPS |
| **products** | 1M × 5 КБ | 5 ГБ | 100 QPS | 10,000 QPS |
| **product_images** | 5M × 10 КБ | 50 ГБ | 200 QPS | 20,000 QPS |
| **orders** | 50M × 3 КБ | 150 ГБ | 100 QPS | 2,000 QPS |
| **order_items** | 200M × 2 КБ | 400 ГБ | 200 QPS | 3,000 QPS |
| **sklad** | 1K × 2 КБ | 2 МБ | 10 QPS | 500 QPS |
| **stocks** | 2M × 1 КБ | 2 ГБ | 1,000 QPS | 50,000 QPS |
| **carts** | 100K × 1 КБ | 100 МБ | 500 QPS | 5,000 QPS |
| **cart_items** | 500K × 1 КБ | 500 МБ | 1,000 QPS | 10,000 QPS |
| **product_search_cache** | 100K × 5 КБ | 500 МБ | 10,000 QPS | 100,000 QPS |
| **sessions** | 50K × 10 КБ | 500 МБ | 50,000 QPS | 200,000 QPS |
| **replies** | 5M × 2 КБ | 10 ГБ | 100 QPS | 1,000 QPS |

#### Консистентность

| Название таблицы | Консистентность |
|------------------|-------------------|
| **users** | strong |
| **user_addresses** | strong |
| **user_preferences** | eventual |
| **sellers** | strong  |
| **categories** | strong |
| **products** | strong |
| **product_images** | eventual |
| **orders** | strict |
| **order_items** | strict |
| **sklad** | strict |
| **stocks** | strict |
| **carts** | strong |
| **cart_items** | strong |
| **product_search_cache** | eventual |
| **sessions** | session |
| **replies** | eventual  |

## Источники:
[1. DAU & MAU;](https://mediascope.net/upload/iblock/4fe/y85jka00l645h8f5qaw2zd52fhxrz4x3/Ecom%202024_Mediascope.pdf)

[2. Данные по целевой аудитории;](https://be1.ru/stat/wildberries.ru)

[3. Исходные данные;](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)

[4. Исходные данные;](https://www.moysklad.ru/poleznoe/marketplejsy/kak-nachat-prodavat-na-wildberries-gayd-dlya-sellerov/#:~:text=%D0%9C%D0%B0%D1%80%D0%BA%D0%B5%D1%82%D0%BF%D0%BB%D0%B5%D0%B9%D1%81%20Wildberries:%20%D0%BE%D0%B1%D0%B7%D0%BE%D1%80%20%D0%BF%D0%BB%D0%BE%D1%89%D0%B0%D0%B4%D0%BA%D0%B8,-Wildberries%20%E2%80%94%20%D0%BB%D0%B8%D0%B4%D0%B5%D1%80%20%D0%B2&text=%D0%9F%D0%BE%20%D1%81%D0%BE%D0%B1%D1%81%D1%82%D0%B2%D0%B5%D0%BD%D0%BD%D1%8B%D0%BC%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D0%BC%20%D1%80%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B3%D0%BE%20%D0%BC%D0%B0%D1%80%D0%BA%D0%B5%D1%82%D0%BF%D0%BB%D0%B5%D0%B9%D1%81%D0%B0,%D0%BE%D0%BA%D0%BE%D0%BB%D0%BE%204%2C5%20%D0%BC%D0%BB%D0%BD%20%D0%B7%D0%B0%D0%BA%D0%B0%D0%B7%D0%BE%D0%B2.)

[5. Данные про максимальные размеры файлов ддля карточек ттовара;](https://seller.wildberries.ru/instructions/ru/ru/material/item-photo-rules-recommendations-and-common-mistakes)

[6. Количество зарегистрированных пользователей](https://seller.wildberries.ru/about-portal/ru/ru)

[7. Количество ДЦ Wildberries](https://habr.com/ru/companies/finops_ru/articles/948034/)

[8. Доки API Wildberries](https://dev.wildberries.ru/openapi/financial-reports-and-accounting#tag/Balans/paths/~1api~1v1~1account~1balance/get)

[9. Количество продавцов](https://oborot.ru/news/skolko-zarabatyvayut-na-marketplejsah-tolko-18-sellerov-na-wildberries-i-13-sellerov-na-ozon-imeyut-oborot-bolshe-milliona-i195968.html#:~:text=%D0%9A%D0%BE%D0%BB%D0%B8%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%BE%20%D0%BF%D1%80%D0%BE%D0%B4%D0%B0%D0%B2%D1%86%D0%BE%D0%B2,%D0%BF%D0%BB%D0%BE%D1%89%D0%B0%D0%B4%D0%BA%D0%B5%20123%20652%20%D0%B0%D0%BA%D1%82%D0%B8%D0%B2%D0%BD%D1%8B%D1%85%20%D0%BF%D1%80%D0%BE%D0%B4%D0%B0%D0%B2%D1%86%D0%B0.)

[10. Больше всего заказов](https://wiki.mpstats.io/%D0%9B%D0%B8%D1%87%D0%BD%D1%8B%D0%B9_%D0%BA%D0%B0%D0%B1%D0%B8%D0%BD%D0%B5%D1%82/%D0%93%D0%B5%D0%BE%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D1%8F_%D0%B7%D0%B0%D0%BA%D0%B0%D0%B7%D0%BE%D0%B2)

[11. Логическая схема БД](https://miro.com/app/board/uXjVJ8utvA8=/)