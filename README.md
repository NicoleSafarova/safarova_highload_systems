# Курсовая работа  
**Автор:** Николь Сафарова

## 1. Тема  
"**Wildberries**" — крупнейший российский маркетплейс. Платформа для продажи товаров разных категорий.


### Аудитория

#### Целевая аудитория:
- Граждане Российской Федерации (преимущественно 25-34 лет) 
- Женщин 66%
- Мужчин 34%


| Страна      | % пользователей |
|-------------|-----------------|
| Россия      | 94.05  |
| Казахстан  | 1.26  |
| Беларусь      | 1.15  |
| Армения  | 0.52  |
| Другие      | 3.02  |


### Функционал MVP

 1. Создание аккаунта и каталог товаров
 2. Добавление товаров в корзину и оформление заказа
 3. Открытие каждой карточки товара
 4. Написание отзывов
 5. Система уведомлений
 6. Добавление товара на платформу со стороны продавца
 7. Поиск товара
 8. Обновление инфоормации об остатках товара на складе
 9. Оценка логистики, связь доставки товара до пункта выдачи
---

## 2. Расчет нагрузки

### Технические и продуктовые метрики
- MAU: 86,3M
- DAU: 35.5M
- Продаваемых товаров на платформе: 44M
- Количество продавцов (данные 2022): 840 000
- Среднее время сессии: 10 минут
- Количество заказов в день: 4.5M
- Среднее число запросов одного визита: 12 страниц (карточек)
- Размер файла фотографии для товара: 10 МБ максимум
- Количество фотографий на одну карточку товара: до 30 штук


#### 1. Размер хранения
Пусть на хранение текстовой информации о товаре составляет 5КБ. Возьмем примерно 5МБ = 5000КБ на хранение 1 офотографии и возьмем примерно 10 фотографий на каждую карточку.
```
44 000 000 товаров × 5000КБ * 10 фотографий = 2200000000000 КБ = 2200 ТБ

44 000 000 товаров × 5КБ = 220000000 КБ = 0.22 ТБ

0.22 ТБ + 2200ТБ = 2200.22 ТБ на хранение товаров на маркетплейсе
```

Пусть на хранение информации о пользователе, адресов пунктов выдачи о товаре составляет 5КБ. Всего 79 миллионов уникальных полтзователей.
```
86300000 пользователей * 5KБ = 395000000 КБ = 0.395 ТБ на хранение данных о пользователях
```

Пусть на хранение отзывов о товаре с картинками и видео составляет 3КБ. Возьмем в среднем по 50 отзывов на товар.
```
44000000 товаров * 50 * 3KБ = 6600000000 КБ = 6.6 ТБ на хранение данных о пользователях
```
#### 2. Сетевой трафик
```
35 500 000 активных пользователей × 12 карточек за сеанс = 426 888 000 запросов/день

```

| Тип трафика      | Среднесуточная нагрузка | Пиковая нагрузка |
|-------------|-----------------|-----------------|
| Статика (исходящий, 70%) | 150 000 000 * 0.7 * 2 МБ * 0.7 = 147000000 МБ = 147000 ГБ   | - |
| API (исходящий, 25%) | 150 000 000 * 0.25 * 50 МБ = 1875000000 КБ = 1875 ГБ  | - | 
| Заказы и действия (входящий, 5%) | 4.5M * 15 КБ + 12.5M * 50 * 2 КБ = 1 317 500 000 КБ = 1 317.5 ГБ | - |
| Сумма | 150192 ГБ/день | 70 ГБитт/с |

#### 3. RPS
```
35 500 000 активных пользователей × 12 карточек за сеанс = 426 888 000 запросов/день

```

| Функционал      | Расчеты | Средний RPS | Пиковый RPS (х5) |
|-------------|-----------------|-----------------|-----------------|
| Просмотр карточек | 426 888 000 * 0.5 / 86400   | 2470 | 12352 |
| Поиск и просмотр ленты | 426 888 000 * 0.1 / 86400  | 494 | 2470 |
| Добавление в корзину | 4 500 000 / 86400 | 52 | 260 |
| Оформление заказа | 4 500 000  / 86400 | 52 | 260 |
| Авторизация | 35 500 000 * 0.1 / 86400 | 41 | 205 |
| Регистрация | 1 300 000 / 86400  | 15 | 75 |
| Отзывы и вопросы | 4 500 000 * 0.05 / 86400  | 3 | 15 |
| Загрузка изображений | 50 * 35 500 000 * 0.01 / 86400  | 205 | 1027 |
| Изменение данных в профиле или добавление адреса пункта выдачи | 35 500 000 * 0.1 / 86400 | 41 | 205 |
| Обновление инфоормации об остатках товара на складе | 4 500 000 / 86400  | 52 | 260 |
| Логистика | 4 500 000 * 0.1 / 86400  | 92 | 458 |
| Сумма | -  | 3487 | 17587 |

## 3. Глобальная балансировка нагрузки
#### 1. Функциональное разбиение по доменам
https://www.wildberries.ru/ - основной

https://digital.wildberries.ru/ - цифровой Wildberries

https://seller.wildberries.ru/ - для продавцов 


#### 2. Обоснование расположения ДЦ (влияние на продуктовые метрики)
Дата-центры стоит располагать в России (так как большая часть аудитории - это жители России). Я решила расположить 2 ДЦ в Москве и Подмосковье. Основная база данных тоже будет в Москве.

![Загруженность ПВЗ по России](https://wiki.mpstats.io/%D0%B3%D0%B5%D0%BE%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D1%8F_%D0%B7%D0%B0%D0%BA%D0%B0%D0%B7%D0%BE%D0%B2_14.jpg)

#### 3. Схема Anycast балансировки 
По количеству заказов пользователей (на картинке видно по цвету) логично было бы расположить ДЦ в Москве и в Санкт-Петербурге. 
Но задержка трафика между Санкт-Петербуром и Москвой составляет 7,09 мс, поэтому расположим их 2 ДЦ в Москве.
Так как 2 ДЦ в одном городе, то будем использовать BGP Anycast балансировку.
Один ДЦ полностью способен выдержать всю нагрузку (вывод сделан из того, что настоящий ВБ имеет на данный момент 1 ДЦ), но сделаем 2 на случай если упадет один, то работа не прекращалась.

Схема BGP Anycast:
1) Задаем 1 IP-адресс для этих двух ДЦ;
2) С помощью протокола BGP, BGP-маршрутизаторы в сети клиента определяют лучший маршрут и направляет его в доступный узел (трафик автоматически направляется к ближайшему ДЦ);
3) Если один узел недоступный,то клиента отправляет на ближайший доступный.


## 4. Локальная балансировка нагрузки

### Схема локальной балансировки
После попадания пользователя на один из ДЦ (благодаря Virtual Server via Direct Routing попадает на L4-балансировщики), его запрос обрабатывается L4-балансировщиком, который использует алгоритм Least Connections (распределяет на машину с наименьшим числом подключений) для распределения трафика между L7 балансировщиками. Каждый L7-балансировщик работает на отдельной машине с установленным Nginx, где происходит терминация SSL и распределение по серверам на бэкенде по алгоритму Weighted Round Robin.
![Схема локальной балансировки](Локальная%20балансировка.png)

| Компонент     | Формула резервирования |
|-------------|-----------------|
| L4-балансировщики | N+1 |
| L7-балансировщики | N+1 |
| Бэкенд серверы | N+1 |


## 5. Логическая БД

![Логическая схема БД](Highload%20Diagram.png)

| Таблица | Назначение |
|---------|------------|
| **users** | Основная информация о пользователях |
| **user_addresses** | Адреса доставки | 
| **user_preferences** | Адреса ПВЗ | 
| **sellers** | Информация о продавцах | 
| **categories** | Категории товаров | 
| **products** | Основная информация о товарах |  
| **product_images** | Изображения товаров | 
| **orders** | Заголовки заказов |   
| **order_items** | Состав заказов |  
| **sklad** | Склады |  
| **stocks** | Остатки товаров |  
| **carts** | Корзины покупок |   
| **cart_items** | Элементы корзины |  
| **product_search_cache** | Кэш поиска | 
| **sessions** | Сессии |  
| **replies** | Отзывы |  

#### Расчтеты

| Название таблицы | Расчеты | Результат | Нагрузка на запись | Нагрузка на чтение  |
|------------------|---------|-----------|-------------------|-------------------|
| **users** | 86.3M × 2 КБ | 172.6 ГБ | 5 QPS | 820 QPS |
| **user_addresses** | 129.5M × 1 КБ | 129.5 ГБ | 41 QPS | 205 QPS |
| **user_preferences** | 86.3M × 0.5 КБ | 43.2 ГБ | 20 QPS | 410 QPS |
| **sellers** | 840K × 3 КБ | 2.5 ГБ | 0.3 QPS | 120 QPS |
| **categories** | 50K × 1 КБ | 50 МБ | 0.1 QPS | 821 QPS |
| **products** | 44M × 5 КБ | 220 ГБ | 52 QPS | 4 500 QPS |
| **product_images** | 440M × 5 КБ | 2.2 ТБ | 7 QPS | 49 305 QPS |
| **orders** | 1.65B × 3 КБ | 4.9 ТБ | 521 QPS | 205 QPS |
| **order_items** | 8.2B × 2 КБ | 16.4 ТБ | 2 600 QPS | 620 QPS |
| **sklad** | 10K × 2 КБ | 20 МБ | 0.01 QPS | 41 QPS |
| **stocks** | 44M × 1 КБ | 44 ГБ | 2 604 QPS | 49 300 QPS |
| **carts** | 3.55M × 1 КБ | 3.55 ГБ | 822 QPS | 821 QPS |
| **cart_items** | 17.75M × 1 КБ | 17.75 ГБ | 6 163 QPS | 1 643 QPS |
| **product_search_cache** | 426M × 5 КБ | 2.13 ТБ | 1 232 QPS | 2 470 QPS |
| **sessions** | 35.5M × 10 КБ | 355 ГБ | 500 QPS | 410 QPS |
| **replies** | 440M × 2 КБ | 880 ГБ | 26 QPS | 4 930 QPS |


#### Консистентность

| Название таблицы | Консистентность |
|------------------|-------------------|
| **users** | strong |
| **user_addresses** | strong |
| **user_preferences** | eventual |
| **sellers** | strong  |
| **categories** | strong |
| **products** | strong |
| **product_images** | eventual |
| **orders** | strict |
| **order_items** | strict |
| **sklad** | strict |
| **stocks** | strict |
| **carts** | strong |
| **cart_items** | strong |
| **product_search_cache** | eventual |
| **sessions** | session |
| **replies** | eventual  |


| Таблица | Запись | Чтение |
|---------|----------------|------------|
| **users** | Регистрация, обновление профиля, смена пароля | Авторизация, просмотр профиля, проверка данных |
| **user_addresses** | Добавление/редактирование адресов доставки | Выбор адреса при заказе, просмотр списка адресов |
| **user_preferences** | Изменение настроек, выбор ПВЗ, смена языка | Загрузка настроек при входе, применение предпочтений |
| **sellers** | Регистрация продавцов, обновление данных | Просмотр карточки продавца, проверка рейтинга |
| **categories** | Добавление/редактирование категорий | Построение навигации, фильтрация товаров |
| **products** | Добавление товаров, обновление цен, редактирование описаний | Поиск товаров, просмотр карточек, фильтрация |
| **product_images** | Загрузка новых фото, обновление изображений | Отображение фото в превью, галерея товара |
| **orders** | Создание заказов, обновление статуса, трекинг | Просмотр истории заказов, отслеживание статуса |
| **order_items** | Добавление товаров в заказ, обновление количества | Просмотр состава заказа, аналитика продаж |
| **sklad** | Добавление складов, обновление данных | Выбор ПВЗ, расчет доставки, проверка наличия |
| **stocks** | Обновление остатков при заказах, пополнение | Проверка наличия, бронирование товаров |
| **carts** | Создание корзины, обновление промокодов | Загрузка корзины при входе, применение скидок |
| **cart_items** | Добавление товаров в корзину, изменение количества | Отображение состава корзины, расчет суммы |
| **product_search_cache** | Кэширование результатов поиска, инвалидация | Быстрый поиск товаров, автодополнение |
| **sessions** | Создание сессии, сохранение данных | Проверка авторизации, восстановление состояния |
| **replies** | Добавление отзывов, ответы продавцов, модерация | Просмотр отзывов, расчет рейтинга товаров |

## 6. Физическая БД

![Физическая схема БД](Highload%20Diagram.png)


| Таблица | СУБД | Шардинг | Индексы | Денормализация | Партиционирование |
|---------|------|---------|---------|----------------|-----------|
| users | PostgreSQL | hash(id) | PK(id), email, created_at | - | По created_at|
| user_addresses | PostgreSQL | hash(user_id) | PK(id), user_id | - | - |
| user_preferences | PostgreSQL | hash(user_id)  | PK(id), user_id | - |- |
| sellers | PostgreSQL | hash(seller_id) | PK(id), rating | - |- |
| categories | PostgreSQL | - | PK(id) | - | - |
| products | PostgreSQL | hash(product_id)  | PK(id), seller_id, category_id, created_at | - | По category_id |
| product_images | MongoDB | hash(product_id)  | product_id | - |- |
| orders | PostgreSQL | hash(user_id) | PK(id), user_id, order_date, status | - | По order_date |
| order_items | PostgreSQL | hash(order_id)  | PK(id), order_id, product_id | - |По order_id |
| sklad | PostgreSQL | - | PK(id), city, capacity | - |По city |
| stocks | MongoDB | hash(product_id) | PK(id), sklad_id, product_id | - |По sklad_id |
| carts | PostgreSQL | hash(user_id) | PK(id), user_id, session_id | - | - |
| cart_items | MongoDB | hash(user_id) | cart_id, product_id | - | - |
| product_search_cache | Redis Cluster | Автошардинг | {id: 1}, {category_id: 1} | Полнотекстовый поиск | - |
| sessions | Redis | hash(session_id) | {session_id: 1} | TTL 30 минут | - |
| replies | PostgreSQL | hash(seller_id) | PK(id), seller_id, user_id, rating | - | - |


## 7.Алгоритмы
| Алгоритм | Область применения | Мотивационная часть |
|------------------|-------------------|----------|
| Circuit Breaker | Для микросервисов | Предотвращает сбои, изолируя сбойный сервис и перенаправляя запросы на резервный вариант |
| LFU (Least Frequently Used)  | Кэш | Удаляет наименее используемую информацию |
| Token Bucket | Для трафика | Обеспечивает соответствие трафика заданным лимитам пропускной способности и сглаживает перегрузки в сети |

## 8.Технологии
| Технологии | Область применения | Мотивационная часть |
|------------------|-------------------|----------|
| RabbitMQ | Обработка заказов в пиковые часы, распродажи в праздники | RabbitMQ обеспечит отказоустойчивую асинхронную обработку 4.5 миллионов заказов ежедневно, гарантируя стабильность платформы Wildberries даже в периоды экстремальных нагрузок и предотвращая потерю выручки из-за технических сбоев |
| Master-Slave | Для кэша | Master - прием обновлений кэша, Slave - обслуживание запросов на чтение кэша  |
| Микросервисы | Пользователи, товары, склады |
| API Gateway (Nginx) | Везде  | Маршрутизация запросов по микросервисам |
| WAL (Write-Ahead Logging) | Для  PostgreSQL  | Предотвращения потери данных в случае сбоя оборудования, сбоя PostgreSQL и т.д. |
|Prometheus + Grafana| Мониторинг и отрисовка метрик| Выявлять проблемы, анализировать производительность и принимать обоснованные решения по оптимизации |


## Источники:
[1. DAU & MAU;](https://mediascope.net/upload/iblock/4fe/y85jka00l645h8f5qaw2zd52fhxrz4x3/Ecom%202024_Mediascope.pdf)

[2. Данные по целевой аудитории;](https://be1.ru/stat/wildberries.ru)

[3. Исходные данные;](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)

[4. Исходные данные;](https://www.moysklad.ru/poleznoe/marketplejsy/kak-nachat-prodavat-na-wildberries-gayd-dlya-sellerov/#:~:text=%D0%9C%D0%B0%D1%80%D0%BA%D0%B5%D1%82%D0%BF%D0%BB%D0%B5%D0%B9%D1%81%20Wildberries:%20%D0%BE%D0%B1%D0%B7%D0%BE%D1%80%20%D0%BF%D0%BB%D0%BE%D1%89%D0%B0%D0%B4%D0%BA%D0%B8,-Wildberries%20%E2%80%94%20%D0%BB%D0%B8%D0%B4%D0%B5%D1%80%20%D0%B2&text=%D0%9F%D0%BE%20%D1%81%D0%BE%D0%B1%D1%81%D1%82%D0%B2%D0%B5%D0%BD%D0%BD%D1%8B%D0%BC%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D0%BC%20%D1%80%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B3%D0%BE%20%D0%BC%D0%B0%D1%80%D0%BA%D0%B5%D1%82%D0%BF%D0%BB%D0%B5%D0%B9%D1%81%D0%B0,%D0%BE%D0%BA%D0%BE%D0%BB%D0%BE%204%2C5%20%D0%BC%D0%BB%D0%BD%20%D0%B7%D0%B0%D0%BA%D0%B0%D0%B7%D0%BE%D0%B2.)

[5. Данные про максимальные размеры файлов ддля карточек ттовара;](https://seller.wildberries.ru/instructions/ru/ru/material/item-photo-rules-recommendations-and-common-mistakes)

[6. Количество зарегистрированных пользователей](https://seller.wildberries.ru/about-portal/ru/ru)

[7. Количество ДЦ Wildberries](https://habr.com/ru/companies/finops_ru/articles/948034/)

[8. Доки API Wildberries](https://dev.wildberries.ru/openapi/financial-reports-and-accounting#tag/Balans/paths/~1api~1v1~1account~1balance/get)

[9. Количество продавцов](https://oborot.ru/news/skolko-zarabatyvayut-na-marketplejsah-tolko-18-sellerov-na-wildberries-i-13-sellerov-na-ozon-imeyut-oborot-bolshe-milliona-i195968.html#:~:text=%D0%9A%D0%BE%D0%BB%D0%B8%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%BE%20%D0%BF%D1%80%D0%BE%D0%B4%D0%B0%D0%B2%D1%86%D0%BE%D0%B2,%D0%BF%D0%BB%D0%BE%D1%89%D0%B0%D0%B4%D0%BA%D0%B5%20123%20652%20%D0%B0%D0%BA%D1%82%D0%B8%D0%B2%D0%BD%D1%8B%D1%85%20%D0%BF%D1%80%D0%BE%D0%B4%D0%B0%D0%B2%D1%86%D0%B0.)

[10. Больше всего заказов](https://wiki.mpstats.io/%D0%9B%D0%B8%D1%87%D0%BD%D1%8B%D0%B9_%D0%BA%D0%B0%D0%B1%D0%B8%D0%BD%D0%B5%D1%82/%D0%93%D0%B5%D0%BE%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D1%8F_%D0%B7%D0%B0%D0%BA%D0%B0%D0%B7%D0%BE%D0%B2)

[11. Логическая схема БД](https://miro.com/app/board/uXjVJ8utvA8=/)