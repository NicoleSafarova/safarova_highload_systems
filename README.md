# Курсовая работа  
**Автор:** Николь Сафарова

## 1. Тема  
"**Wildberries**" — крупнейший российский маркетплейс. Платформа для продажи товаров разных категорий.


### Аудитория

#### Целевая аудитория:
- Граждане Российской Федерации (преимущественно 25-34 лет) 
- Женщин 66%
- Мужчин 34%


| Страна      | % пользователей |
|-------------|-----------------|
| Россия      | 94.05  |
| Казахстан  | 1.26  |
| Беларусь      | 1.15  |
| Армения  | 0.52  |
| Другие      | 3.02  |


### Функционал MVP

 1. Создание аккаунта и каталог товаров
 2. Добавление товаров в корзину и оформление заказа
 3. Открытие каждой карточки товара
 4. Написание отзывов
 5. Система уведомлений
 6. Добавление товара на платформу со стороны продавца
 7. Поиск товара
 8. Обновление инфоормации об остатках товара на складе
 9. Оценка логистики, связь доставки товара до пункта выдачи
---

## 2. Расчет нагрузки

### Технические и продуктовые метрики
- MAU: 86,3M
- DAU: 35.5M
- Продаваемых товаров на платформе: 44M
- Количество продавцов (данные 2022): 840 000
- Среднее время сессии: 10 минут
- Количество заказов в день: 4.5M
- Среднее число запросов одного визита: 12 страниц (карточек)
- Размер файла фотографии для товара: 10 МБ максимум
- Количество фотографий на одну карточку товара: до 30 штук


#### 1. Размер хранения
Пусть на хранение текстовой информации о товаре составляет 5КБ. Возьмем примерно 5МБ = 5000КБ на хранение 1 офотографии и возьмем примерно 10 фотографий на каждую карточку.
```
44 000 000 товаров × 5000КБ * 10 фотографий = 2200000000000 КБ = 2200 ТБ

44 000 000 товаров × 5КБ = 220000000 КБ = 0.22 ТБ

0.22 ТБ + 2200ТБ = 2200.22 ТБ на хранение товаров на маркетплейсе
```

Пусть на хранение информации о пользователе, адресов пунктов выдачи о товаре составляет 5КБ. Всего 79 миллионов уникальных полтзователей.
```
86300000 пользователей * 5KБ = 395000000 КБ = 0.395 ТБ на хранение данных о пользователях
```

Пусть на хранение отзывов о товаре с картинками и видео составляет 3КБ. Возьмем в среднем по 50 отзывов на товар.
```
44000000 товаров * 50 * 3KБ = 6600000000 КБ = 6.6 ТБ на хранение данных о пользователях
```
#### 2. Сетевой трафик
```
35 500 000 активных пользователей × 12 карточек за сеанс = 426 888 000 запросов/день

```

| Тип трафика      | Среднесуточная нагрузка | Пиковая нагрузка |
|-------------|-----------------|-----------------|
| Статика (исходящий, 70%) | 150 000 000 * 0.7 * 2 МБ * 0.7 = 147000000 МБ = 147000 ГБ   | - |
| API (исходящий, 25%) | 150 000 000 * 0.25 * 50 МБ = 1875000000 КБ = 1875 ГБ  | - | 
| Заказы и действия (входящий, 5%) | 4.5M * 15 КБ + 12.5M * 50 * 2 КБ = 1 317 500 000 КБ = 1 317.5 ГБ | - |
| Сумма | 150192 ГБ/день | 70 ГБитт/с |

#### 3. RPS
```
35 500 000 активных пользователей × 12 карточек за сеанс = 426 888 000 запросов/день

```

| Функционал      | Расчеты | Средний RPS | Пиковый RPS (х5) |
|-------------|-----------------|-----------------|-----------------|
| Просмотр карточек | 426 888 000 * 0.5 / 86400   | 2470 | 12352 |
| Поиск и просмотр ленты | 426 888 000 * 0.1 / 86400  | 494 | 2470 |
| Добавление в корзину | 4 500 000 / 86400 | 52 | 260 |
| Оформление заказа | 4 500 000  / 86400 | 52 | 260 |
| Авторизация | 35 500 000 * 0.1 / 86400 | 41 | 205 |
| Регистрация | 1 300 000 / 86400  | 15 | 75 |
| Отзывы и вопросы | 4 500 000 * 0.05 / 86400  | 3 | 15 |
| Загрузка изображений | 50 * 35 500 000 * 0.01 / 86400  | 205 | 1027 |
| Изменение данных в профиле или добавление адреса пункта выдачи | 35 500 000 * 0.1 / 86400 | 41 | 205 |
| Обновление инфоормации об остатках товара на складе | 4 500 000 / 86400  | 52 | 260 |
| Логистика | 4 500 000 * 0.1 / 86400  | 92 | 458 |
| Сумма | -  | 3487 | 17587 |

## 3. Глобальная балансировка нагрузки
#### 1. Функциональное разбиение по доменам
https://www.wildberries.ru/ - основной

https://dev.wildberries.ru/openapi/ - информация по API Wildberries / документация 

https://wb-bank.ru/ - Банк ВБ 

https://seller.wildberries.ru/ - для продавцов 

#### 2. Обоснование расположения ДЦ (влияние на продуктовые метрики)
Дата-центры стоит располагать в России (так как большая часть аудитории - это жители России). Я решила расположить 2 ДЦ в Москве и Подмосковье.


| По домену     | Город | Влияние на продуктовые метрики |
|-------------|-----------------|-----------------|
| https://www.wildberries.ru/ | Москва, Санкт-Петербург | Повышает скорость загрузки сайта для пользователей  |
| https://seller.wildberries.ru/  | Электросталь (Подмосковье около самого крупного склада) | Помогает быстро получать информацию по остаткам на складе и обновлять эту информацию периодически  |

#### 3. Anycast балансировка 
2 ДЦ в Москве и Санкт-Петербурге были выбраны по количеству заказов пользователей и жителей, и 1 ДЦ был выбран в Эектростали, потому что там располагается самый большой склад ВБ.
Данные:
- Количество жителей в Москве - 13 150 000 а в Санкт-Петербурге - 5 600 000 (почти в 3 раза меньше)
- Количество заказов (данные 2018) в Москве - 21 000 000 а в Санкт-Петербурге - 4 000 000 (почти в 5 раза меньше)
Делаем вывод, что примерно 2/3 нагрузки будет на москвоский ДЦ

Для пользовательских ДЦ:
1) Трафик автоматически распределяется между двумя центрами (направляет в ближайший к пользователю ДЦ по IP-адресу)
2) Сетевое оборудование автоматически выбирает кратчайший маршрут до него.
3) При отказе любого из центров трафик без вмешательства человека перераспределяется на остальные.

Преимущества:

- Нет перегрузки одного дата-центра (2/3 нагрузки буде на москвоский ДЦ)

- Так как Москва и Санкт-Петербург располагаются рядом, то при отказе пользователя быстро напрявят на другой ДЦ 

## 3. Локальная балансировка нагрузки

### Балансировщик уровня L4

#### Преимущества
- Максимальная производительность - минимальная задержка
- Простота конфигурации и обслуживания
- Эффективен для TCP/UDP трафика (API, WebSockets)
- Низкое потребление ресурсов
- Поддержка миллионов одновременных соединений

#### Алгоритмы распределения нагрузки

##### Round Robin
- Циклическое распределение между серверами
- Простота реализации, равномерное распределение

##### Least Connections
- Отправляет запрос на сервер с наименьшим числом подключений
- Идеально для долгих TCP-сессий

##### Hash-based
- Распределение по хешу IP-адреса клиента
- Гарантирует попадание одного клиента на один сервер

#### Формула резервирования

```math
N_L4 = ⌈(Пиковые_соединения / Соединения_на_узел) × K⌉
```

**Параметры:**
- `Пиковые_соединения`: 1,000,000+ одновременных подключений
- `Соединения_на_узел`: 50,000-100,000 (зависит от HW)
- `К`: коэффициент запаса резервирования

### Балансировщик Уровня 7 (L7)

#### Преимущества
- Интеллектуальная маршрутизация по содержимому
- SSL Termination - разгрузка backend серверов
- Кеширование статического контента
- Безопасность: WAF, rate limiting

#### Алгоритмы распределения нагрузки

##### Content-based Routing
- `/orders` → кластер заказов
- `/static/` → кеширующий кластер  
- `/search/` → поисковый кластер
и тд

##### Least Response Time
- Выбор сервера с наименьшим временем ответа
- Оптимально для динамического контента

##### Consistent Hash
- `/user/{id}` → всегда на один сервер
- Повышает эффективность кеша

##### Weighted Round Robin
- Учет мощности серверов
- Мощные серверы получают больше трафика

#### Формула резервирования

```math
N_L7 = ⌈(RPS × Сложность × 1.3) / (RPS_на_узел × уровень)⌉
```

## Архитектура для Wildberries

### L4 Балансировщики (Входная точка)
- Роль: Прием входящего трафика, SSL offloading
- Расположение: Разные зоны доступности

### L7 Балансировщики (Внутренняя маршрутизация)

- Роль: Маршрутизация по сервисам, кеширование, безопасность
- Распределение: По кластерам сервисов

## Пример расчета для Wildberries

### L4 Балансировщики
```
Пиковые подключения: 2,000,000
На один узел: 80,000 соединений
N_L4 = ⌈(2,000,000 / 80,000) × 1.2⌉ = 30 узлов
С резервированием: 30 × 2 = 60 узлов (актив-актив)
```

### L7 Балансировщики
```
Пиковый RPS: 150,000
Сложность: 1.5 (много динамических запросов)
На один узел: 15,000 RPS
N_L7 = ⌈(150,000 × 1.5 × 1.3) / (15,000 × 0.7)⌉ = 28 узлов
С резервированием: 28 × 1.5 = 42 узла
```

## Итог

### L4 Используем для:
- Входящего TCP/UDP трафика
- Балансировки между L7 балансировщиками
- Сервисов с долгими соединениями

### L7 Используем для:
- HTTP/HTTPS маршрутизации
- Разделения трафика между микросервисами
- Кеширования и оптимизации контента
- Безопасности

## Источники:
[1. DAU & MAU;](https://mediascope.net/upload/iblock/4fe/y85jka00l645h8f5qaw2zd52fhxrz4x3/Ecom%202024_Mediascope.pdf)

[2. Данные по целевой аудитории;](https://be1.ru/stat/wildberries.ru)

[3. Исходные данные;](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)

[4. Исходные данные;](https://www.moysklad.ru/poleznoe/marketplejsy/kak-nachat-prodavat-na-wildberries-gayd-dlya-sellerov/#:~:text=%D0%9C%D0%B0%D1%80%D0%BA%D0%B5%D1%82%D0%BF%D0%BB%D0%B5%D0%B9%D1%81%20Wildberries:%20%D0%BE%D0%B1%D0%B7%D0%BE%D1%80%20%D0%BF%D0%BB%D0%BE%D1%89%D0%B0%D0%B4%D0%BA%D0%B8,-Wildberries%20%E2%80%94%20%D0%BB%D0%B8%D0%B4%D0%B5%D1%80%20%D0%B2&text=%D0%9F%D0%BE%20%D1%81%D0%BE%D0%B1%D1%81%D1%82%D0%B2%D0%B5%D0%BD%D0%BD%D1%8B%D0%BC%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D0%BC%20%D1%80%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B3%D0%BE%20%D0%BC%D0%B0%D1%80%D0%BA%D0%B5%D1%82%D0%BF%D0%BB%D0%B5%D0%B9%D1%81%D0%B0,%D0%BE%D0%BA%D0%BE%D0%BB%D0%BE%204%2C5%20%D0%BC%D0%BB%D0%BD%20%D0%B7%D0%B0%D0%BA%D0%B0%D0%B7%D0%BE%D0%B2.)

[5. Данные про максимальные размеры файлов ддля карточек ттовара;](https://seller.wildberries.ru/instructions/ru/ru/material/item-photo-rules-recommendations-and-common-mistakes)

[6. Количество зарегистрированных пользователей](https://seller.wildberries.ru/about-portal/ru/ru)

[7. Количество ДЦ Wildberries](https://habr.com/ru/companies/finops_ru/articles/948034/)

[8. Доки API Wildberries](https://dev.wildberries.ru/openapi/financial-reports-and-accounting#tag/Balans/paths/~1api~1v1~1account~1balance/get)

[9. Количество продавцов](https://oborot.ru/news/skolko-zarabatyvayut-na-marketplejsah-tolko-18-sellerov-na-wildberries-i-13-sellerov-na-ozon-imeyut-oborot-bolshe-milliona-i195968.html#:~:text=%D0%9A%D0%BE%D0%BB%D0%B8%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%BE%20%D0%BF%D1%80%D0%BE%D0%B4%D0%B0%D0%B2%D1%86%D0%BE%D0%B2,%D0%BF%D0%BB%D0%BE%D1%89%D0%B0%D0%B4%D0%BA%D0%B5%20123%20652%20%D0%B0%D0%BA%D1%82%D0%B8%D0%B2%D0%BD%D1%8B%D1%85%20%D0%BF%D1%80%D0%BE%D0%B4%D0%B0%D0%B2%D1%86%D0%B0.)

[10. Больше всего заказов](https://wiki.mpstats.io/%D0%9B%D0%B8%D1%87%D0%BD%D1%8B%D0%B9_%D0%BA%D0%B0%D0%B1%D0%B8%D0%BD%D0%B5%D1%82/%D0%93%D0%B5%D0%BE%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D1%8F_%D0%B7%D0%B0%D0%BA%D0%B0%D0%B7%D0%BE%D0%B2)